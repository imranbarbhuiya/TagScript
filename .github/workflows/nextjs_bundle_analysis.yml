name: 'Next.js Bundle Analysis'

on:
    pull_request:
    push:
        branches:
            - main
    workflow_dispatch:

defaults:
    run:
        working-directory: ./apps/website

permissions:
    contents: read
    actions: read
    pull-requests: write

jobs:
    analyze:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Install Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: Install dependencies
              uses: bahmutov/npm-install@v1

            - name: Restore next build
              uses: actions/cache@v3
              id: restore-build-cache
              env:
                  cache-name: cache-next-build
              with:
                  path: .next/cache
                  key: ${{ runner.os }}-build-${{ env.cache-name }}

            - name: Build next.js app
              run: ./node_modules/.bin/next build

            - name: Analyze bundle
              run: npx -p nextjs-bundle-analysis report

            - name: Upload bundle
              uses: actions/upload-artifact@v3
              with:
                  name: bundle
                  path: .next/analyze/__bundle_analysis.json

            - name: Download base branch bundle stats
              uses: dawidd6/action-download-artifact@v2
              if: success() && github.event.number
              with:
                  workflow: nextjs_bundle_analysis.yml
                  branch: ${{ github.event.pull_request.base.ref }}
                  path: .next/analyze/base

            - name: Compare with base branch bundle
              if: success() && github.event.number
              run: ls -laR .next/analyze/base && npx -p nextjs-bundle-analysis compare

            - name: Get comment body
              id: get-comment-body
              if: success() && github.event.number
              uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6
              with:
                  result-encoding: string
                  script: |
                      const fs = require('fs');
                      const comment = fs.readFileSync('./apps/website/.next/analyze/__bundle_analysis_comment.txt', 'utf8');
                      core.setOutput('body', comment);
            - name: Add comment to PR
              uses: marocchino/sticky-pull-request-comment@f61b6cf21ef2fcc468f4345cdfcc9bda741d2343 # v2.6.2
              if: success() && github.event.number
              with:
                  header: 'bundle-analysis-website'
                  message: ${{ steps.get-comment-body.outputs.body }}
