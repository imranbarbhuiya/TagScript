name: 'Next.js Bundle Analysis'

on:
    pull_request:
    push:
        branches:
            - main
    workflow_dispatch:

defaults:
    run:
        working-directory: ./apps/website

permissions:
    contents: read
    actions: read
    pull-requests: write

jobs:
    analyze:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Project
              uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3
            - name: Use Node.js v18
              uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c # v3
              with:
                  node-version: 18
                  cache: yarn
                  registry-url: https://registry.npmjs.org/
            - name: Install Dependencies
              uses: ./scripts/yarnCache

            - name: Cache Next Build
              uses: actions/cache@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # v3.3.1
              with:
                  path: ${{ github.workspace }}/apps/website/.next/cache
                  key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**.[jt]sx?') }}
                  restore-keys: |
                      ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-

            - name: Build next.js app
              run: yarn run --top-level build --filter=website

            - name: Analyze bundle
              run: npx -p nextjs-bundle-analysis report

            - name: Upload bundle
              uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # v3
              with:
                  name: bundle
                  path: .next/analyze/__bundle_analysis.json

            - name: Download base branch bundle stats
              uses: dawidd6/action-download-artifact@246dbf436b23d7c49e21a7ab8204ca9ecd1fe615 # v2
              if: success() && github.event.number
              with:
                  workflow: nextjs_bundle_analysis.yml
                  branch: ${{ github.event.pull_request.base.ref }}
                  path: .next/analyze/base

            - name: Compare with base branch bundle
              if: success() && github.event.number
              run: ls -laR .next/analyze/base && npx -p nextjs-bundle-analysis compare

            - name: Get comment body
              id: get-comment-body
              if: success() && github.event.number
              uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6
              with:
                  result-encoding: string
                  script: |
                      const fs = require('fs');
                      const comment = fs.readFileSync('./apps/website/.next/analyze/__bundle_analysis_comment.txt', 'utf8');
                      core.setOutput('body', comment);
            - name: Add comment to PR
              uses: marocchino/sticky-pull-request-comment@f61b6cf21ef2fcc468f4345cdfcc9bda741d2343 # v2.6.2
              if: success() && github.event.number
              with:
                  header: 'bundle-analysis-website'
                  message: ${{ steps.get-comment-body.outputs.body }}
